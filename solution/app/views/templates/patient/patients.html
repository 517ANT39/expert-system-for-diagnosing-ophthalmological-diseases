<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞—Ü–∏–µ–Ω—Ç—ã - –û—Ñ—Ç–∞–ª—å–º–æ–≠–∫—Å–ø–µ—Ä—Ç</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/patients.css') }}">
    <style>
        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .action-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: nowrap;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
        }
    </style>
</head>
<body class="dashboard-page">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="{{ url_for('dashboard') }}" class="logo logo-link">
                    <span class="logo-icon">üëÅÔ∏è</span>
                    <span class="logo-text">–û—Ñ—Ç–∞–ª—å–º–æ–≠–∫—Å–ø–µ—Ä—Ç</span>
                </a>
                <div class="nav-links">
                    <a href="{{ url_for('dashboard') }}" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="{{ url_for('patient_list') }}" class="nav-link active">–ü–∞—Ü–∏–µ–Ω—Ç—ã</a>
                    <a href="{{ url_for('consultation') }}" class="nav-link">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</a>
                    <div class="user-menu">
                        <a href="{{ url_for('profile') }}" class="user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</a>
                        <a href="{{ url_for('logout') }}" class="btn btn-sm btn-secondary">–í—ã–π—Ç–∏</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container main-content">
        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞–º–∏</h1>
                <p class="text-muted">–í—Å–µ –ø–∞—Ü–∏–µ–Ω—Ç—ã –≤ —Å–∏—Å—Ç–µ–º–µ</p>
            </div>
            <div class="header-actions">
                <a href="{{ url_for('patient_new') }}" class="btn btn-primary btn-sm">
                    –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞
                </a>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="card">
            <div class="card-header">
                <h2>–ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã</h2>
            </div>
            <div class="card-content">
                <div class="patients-filters-grid">
                    <div class="search-box">
                        <input type="text" id="patientSearch" class="form-control" 
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û, ID –∏–ª–∏ –¥–∏–∞–≥–Ω–æ–∑—É...">
                        <button class="btn btn-primary btn-sm" onclick="searchPatients()">
                            –ü–æ–∏—Å–∫
                        </button>
                    </div>
                    <div class="filter-options">
                        <select id="statusFilter" class="form-control">
                            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                            <option value="archived">–í –∞—Ä—Ö–∏–≤–µ</option>
                        </select>
                        <select id="sortBy" class="form-control">
                            <option value="name">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∏–º–µ–Ω–∏</option>
                            <option value="date">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ</option>
                            <option value="lastVisit">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –≤–∏–∑–∏—Ç—É</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patients List -->
        <div class="card">
            <div class="card-header">
                <div class="patients-header-content">
                    <h2>–°–ø–∏—Å–æ–∫ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</h2>
                    <div class="patient-count text-muted">
                        –ù–∞–π–¥–µ–Ω–æ: <span id="patientCount">{{ patients|length if patients else 0 }}</span> –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
                    </div>
                </div>
            </div>
            
            <div class="card-content">
                {% if patients %}
                <div class="table-responsive">
                    <table class="table" id="patientsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–§–ò–û</th>
                                <th>–í–æ–∑—Ä–∞—Å—Ç</th>
                                <th>–ü–æ–ª</th>
                                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                <th>Email</th>
                                <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for patient in patients %}
                            <tr>
                                <td>#{{ patient.id }}</td>
                                <td>
                                    <div class="patient-info">
                                        <strong>{{ patient.last_name }} {{ patient.first_name }} {{ patient.middle_name or '' }}</strong>
                                        {% if patient.email %}
                                        <span class="text-muted text-sm">{{ patient.email }}</span>
                                        {% elif patient.phone %}
                                        <span class="text-muted text-sm">{{ patient.phone }}</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if patient.age %}
                                        {{ patient.age }}
                                        {% set age = patient.age %}
                                        {% if age % 10 == 1 and age % 100 != 11 %}
                                            –≥–æ–¥
                                        {% elif age % 10 >= 2 and age % 10 <= 4 and (age % 100 < 10 or age % 100 >= 20) %}
                                            –≥–æ–¥–∞
                                        {% else %}
                                            –ª–µ—Ç
                                        {% endif %}
                                    {% else %}
                                        –ù–µ —É–∫–∞–∑–∞–Ω
                                    {% endif %}
                                </td>
                                <td>{{ '–ú—É–∂—Å–∫–æ–π' if patient.sex == 'M' else '–ñ–µ–Ω—Å–∫–∏–π' }}</td>
                                <td>{{ patient.phone or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</td>
                                <td>{{ patient.email or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</td>
                                <td>{{ patient.registered_at.strftime('%d.%m.%Y') if patient.registered_at else '–ù–µ —É–∫–∞–∑–∞–Ω–∞' }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{{ url_for('patient_history', patient_id=patient.id) }}" class="btn btn-sm btn-secondary">
                                            –ò—Å—Ç–æ—Ä–∏—è
                                        </a>
                                        <a href="{{ url_for('consultation', patient_id=patient.id) }}" class="btn btn-sm btn-primary">
                                            –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination">
                    <button class="btn btn-secondary btn-sm" disabled>‚Üê –ù–∞–∑–∞–¥</button>
                    <span class="page-info text-muted">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ 1</span>
                    <button class="btn btn-secondary btn-sm" disabled>–í–ø–µ—Ä–µ–¥ ‚Üí</button>
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üë•</div>
                    <h3>–°–ø–∏—Å–æ–∫ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –ø—É—Å—Ç</h3>
                    <p class="text-muted">–í —Å–∏—Å—Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É.</p>
                    <a href="{{ url_for('patient_new') }}" class="btn btn-primary btn-sm">
                        –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </main>

    <script>
        function searchPatients() {
            const searchTerm = document.getElementById('patientSearch').value;
            
            // AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
            fetch(`/api/patients/search?term=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updatePatientsTable(data.patients);
                    } else {
                        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', data.message);
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞');
                });
        }

        function updatePatientsTable(patients) {
            const tbody = document.querySelector('#patientsTable tbody');
            const patientCount = document.getElementById('patientCount');
            
            if (!patients || patients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            –ü–∞—Ü–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                        </td>
                    </tr>
                `;
                patientCount.textContent = '0';
                return;
            }
            
            let html = '';
            patients.forEach(patient => {
                const fullName = `${patient.last_name} ${patient.first_name} ${patient.middle_name || ''}`;
                const contactInfo = patient.email || patient.phone;
                const registeredAt = patient.registered_at ? new Date(patient.registered_at).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
                const sex = patient.sex === 'M' ? '–ú—É–∂—Å–∫–æ–π' : '–ñ–µ–Ω—Å–∫–∏–π';
                
                // –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞
                let ageText = '–ù–µ —É–∫–∞–∑–∞–Ω';
                if (patient.age) {
                    const age = patient.age;
                    if (age % 10 == 1 && age % 100 != 11) {
                        ageText = age + ' –≥–æ–¥';
                    } else if (age % 10 >= 2 && age % 10 <= 4 && (age % 100 < 10 || age % 100 >= 20)) {
                        ageText = age + ' –≥–æ–¥–∞';
                    } else {
                        ageText = age + ' –ª–µ—Ç';
                    }
                }
                
                html += `
                    <tr>
                        <td>#${patient.id}</td>
                        <td>
                            <div class="patient-info">
                                <strong>${fullName}</strong>
                                ${contactInfo ? `<span class="text-muted text-sm">${contactInfo}</span>` : ''}
                            </div>
                        </td>
                        <td>${ageText}</td>
                        <td>${sex}</td>
                        <td>${patient.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                        <td>${patient.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                        <td>${registeredAt}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="/patient/${patient.id}/history" class="btn btn-sm btn-secondary">
                                    –ò—Å—Ç–æ—Ä–∏—è
                                </a>
                                <a href="/consultation?patient_id=${patient.id}" class="btn btn-sm btn-primary">
                                    –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            patientCount.textContent = patients.length;
        }
    </script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
</body>
</html>