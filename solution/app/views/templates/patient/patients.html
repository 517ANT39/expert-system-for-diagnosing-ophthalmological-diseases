<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞—Ü–∏–µ–Ω—Ç—ã - –û—Ñ—Ç–∞–ª—å–º–æ–≠–∫—Å–ø–µ—Ä—Ç</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/patients.css') }}">
    <style>
        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .patient-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .patient-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .patient-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .patient-contact {
            color: #666;
            font-size: 0.9rem;
            margin-top: 4px;
        }

        .patient-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 2px;
        }

        .detail-value {
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
        }

        .card-actions {
            border-top: 1px solid #f0f0f0;
            padding-top: 12px;
            margin-top: 12px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-top: 20px;
            padding: 16px;
        }

        .page-info {
            font-size: 0.9rem;
            color: #666;
        }

        .patient-page {
            display: none;
        }

        .patient-page.active {
            display: block;
        }

        @media (max-width: 768px) {
            .patient-details {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 480px) {
            .patient-details {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                width: 100%;
                text-align: center;
            }

            .pagination {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body class="dashboard-page">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="{{ url_for('dashboard') }}" class="logo logo-link">
                    <span class="logo-icon">üëÅÔ∏è</span>
                    <span class="logo-text">–û—Ñ—Ç–∞–ª—å–º–æ–≠–∫—Å–ø–µ—Ä—Ç</span>
                </a>
                <div class="nav-links">
                    <a href="{{ url_for('dashboard') }}" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="{{ url_for('patient_list') }}" class="nav-link active">–ü–∞—Ü–∏–µ–Ω—Ç—ã</a>
                    <a href="{{ url_for('consultation') }}" class="nav-link">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</a>
                    <div class="user-menu">
                        <a href="{{ url_for('profile') }}" class="user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</a>
                        <a href="{{ url_for('logout') }}" class="btn btn-sm btn-secondary">–í—ã–π—Ç–∏</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container main-content">
        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞–º–∏</h1>
                <p class="text-muted">–í—Å–µ –ø–∞—Ü–∏–µ–Ω—Ç—ã –≤ —Å–∏—Å—Ç–µ–º–µ</p>
            </div>
            <div class="header-actions">
                <a href="{{ url_for('patient_new') }}" class="btn btn-primary btn-sm">
                    –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞
                </a>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="card">
            <div class="card-header">
                <div class="search-box">
                    <input type="text" id="patientSearch" class="form-control" 
                           placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û ...">
                    <button class="btn btn-primary btn-sm" onclick="searchPatients()">
                        –ü–æ–∏—Å–∫
                    </button>
                </div>
            </div>
        </div>

        <!-- Patients List -->
        <div class="card">
            <div class="card-header">
                <div class="patients-header-content">
                    <h2>–°–ø–∏—Å–æ–∫ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</h2>
                    <div class="patient-count text-muted">
                        –ù–∞–π–¥–µ–Ω–æ: <span id="patientCount">{{ patients|length if patients else 0 }}</span> –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
                        | –ü–æ–∫–∞–∑–∞–Ω–æ: <span id="showingCount">3</span> –∏–∑ {{ patients|length if patients else 0 }}
                    </div>
                </div>
            </div>
            
            <div class="card-content">
                {% if patients %}
                <div id="patientsList">
                    <!-- –†–∞–∑–¥–µ–ª—è–µ–º –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ 3 —á–µ–ª–æ–≤–µ–∫–∞ -->
                    {% for i in range(0, patients|length, 3) %}
                    <div class="patient-page" id="page{{ (i/3)|int + 1 }}">
                        {% for patient in patients[i:i+3] %}
                        <div class="patient-card">
                            <div class="patient-header">
                                <div>
                                    <h3 class="patient-name">
                                        {{ patient.last_name }} {{ patient.first_name }} {{ patient.middle_name or '' }}
                                    </h3>
                                    
                                </div>
                            </div>
                            
                            <div class="patient-details">
                                <div class="detail-item">
                                    <span class="detail-label">–í–æ–∑—Ä–∞—Å—Ç</span>
                                    <span class="detail-value">
                                        {% if patient.age %}
                                            {{ patient.age }}
                                            {% set age = patient.age %}
                                            {% if age % 10 == 1 and age % 100 != 11 %}
                                                –≥–æ–¥
                                            {% elif age % 10 >= 2 and age % 10 <= 4 and (age % 100 < 10 or age % 100 >= 20) %}
                                                –≥–æ–¥–∞
                                            {% else %}
                                                –ª–µ—Ç
                                            {% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </span>
                                </div>
                                
                                <div class="detail-item">
                                    <span class="detail-label">–ü–æ–ª</span>
                                    <span class="detail-value">{{ '–ú—É–∂—Å–∫–æ–π' if patient.sex == 'M' else '–ñ–µ–Ω—Å–∫–∏–π' }}</span>
                                </div>
                                
                                <div class="detail-item">
                                    <span class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                                    <span class="detail-value">{{ patient.phone or '-' }}</span>
                                </div>
                                
                                <div class="detail-item">
                                    <span class="detail-label">Email</span>
                                    <span class="detail-value">{{ patient.email or '-' }}</span>
                                </div>
                                
                                <div class="detail-item">
                                    <span class="detail-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</span>
                                    <span class="detail-value">
                                        {{ patient.registered_at.strftime('%d.%m.%Y') if patient.registered_at else '-' }}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="card-actions">
                                <div class="action-buttons">
                                    <a href="{{ url_for('patient_history', patient_id=patient.id) }}" class="btn btn-sm btn-secondary">
                                        –ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π
                                    </a>
                                    <a href="{{ url_for('consultation', patient_id=patient.id) }}" class="btn btn-sm btn-primary">
                                        –ù–æ–≤–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                <div class="pagination">
                    <button class="btn btn-secondary btn-sm" id="prevPageBtn">‚Üê –ù–∞–∑–∞–¥</button>
                    <span class="page-info" id="pageInfo">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ {{ ((patients|length / 3)|round(0, 'ceil'))|int }}</span>
                    <button class="btn btn-secondary btn-sm" id="nextPageBtn">–í–ø–µ—Ä–µ–¥ ‚Üí</button>
                </div>
                {% else %}
                <div class="empty-state">
                    <h3>–°–ø–∏—Å–æ–∫ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –ø—É—Å—Ç</h3>
                    <p class="text-muted">–í —Å–∏—Å—Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É.</p>
                    <a href="{{ url_for('patient_new') }}" class="btn btn-primary btn-sm">
                        –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </main>

    <script>
        let currentPage = 1;
        const patientsPerPage = 3;
        let totalPatients = {{ patients|length if patients else 0 }};
        let totalPages = Math.ceil(totalPatients / patientsPerPage);

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            showPage(1);
            updatePagination();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Pagination buttons
            document.getElementById('prevPageBtn').addEventListener('click', function() {
                changePage(-1);
            });
            
            document.getElementById('nextPageBtn').addEventListener('click', function() {
                changePage(1);
            });

            // Search input
            document.getElementById('patientSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchPatients();
                }
            });
        }

        function showPage(pageNumber) {
            // Hide all pages
            const pages = document.querySelectorAll('.patient-page');
            pages.forEach(page => {
                page.classList.remove('active');
            });
            
            // Show current page
            const currentPageElement = document.getElementById('page' + pageNumber);
            if (currentPageElement) {
                currentPageElement.classList.add('active');
            }
            
            // Update showing count
            const startIndex = (pageNumber - 1) * patientsPerPage + 1;
            const endIndex = Math.min(pageNumber * patientsPerPage, totalPatients);
            document.getElementById('showingCount').textContent = endIndex - startIndex + 1;
        }

        function updatePagination() {
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');

            if (pageInfo) {
                pageInfo.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages}`;
            }

            // Update button states
            if (prevBtn) {
                prevBtn.disabled = currentPage === 1;
            }
            if (nextBtn) {
                nextBtn.disabled = currentPage === totalPages;
            }
        }

        function changePage(direction) {
            const newPage = currentPage + direction;

            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                showPage(currentPage);
                updatePagination();
                scrollToTop();
            }
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function searchPatients() {
            const searchTerm = document.getElementById('patientSearch').value;
            
            // AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
            fetch(`/api/patients/search?term=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // –ü–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
                        window.location.href = `/patients?search=${encodeURIComponent(searchTerm)}`;
                    } else {
                        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', data.message);
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞');
                });
        }
    </script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
</body>
</html>