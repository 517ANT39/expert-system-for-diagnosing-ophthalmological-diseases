<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å—Ç–æ—Ä–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞ - –û—Ñ—Ç–∞–ª—å–º–æ–≠–∫—Å–ø–µ—Ä—Ç</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/patient-history.css') }}">
</head>
<body class="dashboard-page">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="{{ url_for('dashboard') }}" class="logo logo-link">
                    <span class="logo-icon">üëÅÔ∏è</span>
                    <span class="logo-text">–û—Ñ—Ç–∞–ª—å–º–æ–≠–∫—Å–ø–µ—Ä—Ç</span>
                </a>
                <div class="nav-links">
                    <a href="{{ url_for('dashboard') }}" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="{{ url_for('patient_list') }}" class="nav-link active">–ü–∞—Ü–∏–µ–Ω—Ç—ã</a>
                    <a href="{{ url_for('consultation') }}" class="nav-link">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</a>
                    <div class="user-menu">
                        <a href="{{ url_for('profile') }}" class="user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</a>
                        <a href="{{ url_for('logout') }}" class="btn btn-sm btn-secondary">–í—ã–π—Ç–∏</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container main-content">
        {% if patient %}
        <!-- Patient Header -->
        <div class="card patient-header">
            <div class="card-content">
                <div class="patient-basic-info">
                    <div class="patient-avatar">
                        <div class="avatar-placeholder">üë§</div>
                    </div>
                    <div class="patient-details">
                        <h1>{{ patient.last_name }} {{ patient.first_name }} {{ patient.middle_name or '' }}</h1>
                        <div class="patient-meta">
                            <span class="meta-item">
                                <strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> 
                                {% if patient.birthday %}
                                    {{ patient.birthday.strftime('%d.%m.%Y') }} ({{ patient.age }} –ª–µ—Ç)
                                {% else %}
                                    –ù–µ —É–∫–∞–∑–∞–Ω–∞
                                {% endif %}
                            </span>
                            <span class="meta-item">
                                <strong>–ü–æ–ª:</strong> 
                                {% if patient.sex.value == 'M' %}
                                    –ú—É–∂—Å–∫–æ–π
                                {% else %}
                                    –ñ–µ–Ω—Å–∫–∏–π
                                {% endif %}
                            </span>
                            <span class="meta-item">
                                <strong>ID –ø–∞—Ü–∏–µ–Ω—Ç–∞:</strong> #{{ patient.id }}
                            </span>
                        </div>
                        <div class="patient-contact">
                            {% if patient.email %}
                            <span class="contact-item">üìß {{ patient.email }}</span>
                            {% endif %}
                            {% if patient.phone %}
                            <span class="contact-item">üìû {{ patient.phone }}</span>
                            {% endif %}
                            {% if patient.address %}
                            <span class="contact-item">üìç {{ patient.address }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="patient-actions">
                    <a href="{{ url_for('consultation', patient_id=patient.id) }}" class="btn btn-primary">
                        üÜï –ù–æ–≤–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è
                    </a>
                    <!-- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –°–°–´–õ–ö–ê - –¥–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ edit_patient -->
                    <a href="{{ url_for('edit_patient', patient_id=patient.id) }}" class="btn btn-sm btn-primary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                </div>
            </div>
        </div>

        <!-- Medical Summary -->
        <div class="medical-summary grid grid-3">
            <div class="card summary-card">
                <div class="card-content">
                    <div class="summary-icon">üìã</div>
                    <div class="summary-content">
                        <div class="summary-number">{{ consultations|length }}</div>
                        <div class="summary-label">–í—Å–µ–≥–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π</div>
                    </div>
                </div>
            </div>
            <div class="card summary-card">
                <div class="card-content">
                    <div class="summary-icon">üìÖ</div>
                    <div class="summary-content">
                        <div class="summary-number">
                            {% if consultations %}
                                {{ consultations[0].consultation_date.strftime('%d.%m.%Y') }}
                            {% else %}
                                –ù–µ—Ç –≤–∏–∑–∏—Ç–æ–≤
                            {% endif %}
                        </div>
                        <div class="summary-label">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç</div>
                    </div>
                </div>
            </div>
            <div class="card summary-card">
                <div class="card-content">
                    <div class="summary-icon">üëÅÔ∏è</div>
                    <div class="summary-content">
                        <div class="summary-number">
                            {% if consultations %}
                                {{ consultations|selectattr('final_diagnosis')|list|length }}
                            {% else %}
                                0
                            {% endif %}
                        </div>
                        <div class="summary-label">–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Consultations Timeline -->
        <div class="card">
            <div class="card-header">
                <div class="card-header-content">
                    <h2>–ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π</h2>
                    <div class="view-options">
                        <button class="btn btn-sm btn-secondary active" data-view="timeline">
                            üìÖ –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞
                        </button>
                        <button class="btn btn-sm btn-secondary" data-view="list">
                            üìã –°–ø–∏—Å–æ–∫
                        </button>
                    </div>
                </div>
            </div>

            <div class="card-content">
                {% if consultations %}
                <div class="consultations-timeline" id="timelineView">
                    {% for consultation in consultations %}
                    <div class="timeline-item">
                        <div class="timeline-marker"></div>
                        <div class="timeline-content">
                            <div class="consultation-header">
                                <div class="consultation-date">
                                    <strong>{{ consultation.consultation_date.strftime('%d.%m.%Y') }}</strong>
                                    <span class="text-muted">{{ consultation.consultation_date.strftime('%H:%M') }}</span>
                                </div>
                                <div class="consultation-actions">
                                    <a href="{{ url_for('consultation_result', consultation_id=consultation.id) }}" class="btn btn-sm btn-secondary">
                                        –ü—Ä–æ—Å–º–æ—Ç—Ä
                                    </a>
                                    <button class="btn btn-sm btn-secondary" onclick="exportConsultation({{ consultation.id }})">
                                        üìÑ PDF
                                    </button>
                                </div>
                            </div>
                            <div class="consultation-diagnosis">
                                <strong>–î–∏–∞–≥–Ω–æ–∑:</strong> 
                                {{ consultation.final_diagnosis or '–î–∏–∞–≥–Ω–æ–∑ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' }}
                            </div>
                            <div class="consultation-status">
                                <strong>–°—Ç–∞—Ç—É—Å:</strong> 
                                {% if consultation.status.value == 'completed' %}
                                    <span class="status-badge status-completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                                {% elif consultation.status.value == 'active' %}
                                    <span class="status-badge status-active">–ê–∫—Ç–∏–≤–Ω–∞</span>
                                {% elif consultation.status.value == 'draft' %}
                                    <span class="status-badge status-draft">–ß–µ—Ä–Ω–æ–≤–∏–∫</span>
                                {% else %}
                                    <span class="status-badge status-canceled">–û—Ç–º–µ–Ω–µ–Ω–∞</span>
                                {% endif %}
                            </div>
                            {% if consultation.notes %}
                            <div class="consultation-notes">
                                <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:</strong> {{ consultation.notes }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- List View (Hidden by default) -->
                <div class="consultations-list" id="listView" style="display: none;">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–î–∏–∞–≥–Ω–æ–∑</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–í—Ä–∞—á</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for consultation in consultations %}
                                <tr>
                                    <td>{{ consultation.consultation_date.strftime('%d.%m.%Y %H:%M') }}</td>
                                    <td>{{ consultation.final_diagnosis or '–î–∏–∞–≥–Ω–æ–∑ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' }}</td>
                                    <td>
                                        {% if consultation.status.value == 'completed' %}
                                            <span class="status-badge status-completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                                        {% elif consultation.status.value == 'active' %}
                                            <span class="status-badge status-active">–ê–∫—Ç–∏–≤–Ω–∞</span>
                                        {% elif consultation.status.value == 'draft' %}
                                            <span class="status-badge status-draft">–ß–µ—Ä–Ω–æ–≤–∏–∫</span>
                                        {% else %}
                                            <span class="status-badge status-canceled">–û—Ç–º–µ–Ω–µ–Ω–∞</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if consultation.doctor %}
                                            {{ consultation.doctor.last_name }} {{ consultation.doctor.first_name }} {{ consultation.doctor.middle_name or '' }}
                                        {% else %}
                                            –í—Ä–∞—á –Ω–µ —É–∫–∞–∑–∞–Ω
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('consultation_result', consultation_id=consultation.id) }}" class="btn btn-sm btn-secondary">
                                            –ü—Ä–æ—Å–º–æ—Ç—Ä
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <h3>–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p class="text-muted">–£ —ç—Ç–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ø–æ–∫–∞ –Ω–µ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π.</p>
                    <a href="{{ url_for('consultation', patient_id=patient.id) }}" class="btn btn-primary">
                        üÜï –ù–∞—á–∞—Ç—å –ø–µ—Ä–≤—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Medical Information -->
        <div class="grid grid-2">
            <!-- Patient Medical Information -->
            <div class="card">
                <div class="card-header">
                    <h3>üè• –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                </div>
                <div class="card-content">
                    <div class="medical-info">
                        <div class="info-section">
                            <h4>–ê–ª–ª–µ—Ä–≥–∏–∏</h4>
                            <p class="text-muted">{{ patient.allergies or '–ù–µ —É–∫–∞–∑–∞–Ω—ã' }}</p>
                        </div>
                        <div class="info-section">
                            <h4>–•—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è</h4>
                            <p class="text-muted">{{ patient.chronic_diseases or '–ù–µ —É–∫–∞–∑–∞–Ω—ã' }}</p>
                        </div>
                        <div class="info-section">
                            <h4>–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞</h4>
                            <p class="text-muted">{{ patient.current_medications or '–ù–µ —É–∫–∞–∑–∞–Ω—ã' }}</p>
                        </div>
                        <div class="info-section">
                            <h4>–°–µ–º–µ–π–Ω—ã–π –∞–Ω–∞–º–Ω–µ–∑</h4>
                            <p class="text-muted">{{ patient.family_anamnes or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</p>
                        </div>
                        {% if patient.notes %}
                        <div class="info-section">
                            <h4>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è</h4>
                            <p class="text-muted">{{ patient.notes }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Registration Information -->
            <div class="card">
                <div class="card-header">
                    <h3>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h3>
                </div>
                <div class="card-content">
                    <div class="registration-info">
                        <div class="info-section">
                            <h4>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h4>
                            <p class="text-muted">
                                {% if patient.registered_at %}
                                    {{ patient.registered_at.strftime('%d.%m.%Y %H:%M') }}
                                {% else %}
                                    –ù–µ —É–∫–∞–∑–∞–Ω–∞
                                {% endif %}
                            </p>
                        </div>
                        <div class="info-section">
                            <h4>–°—Ç–∞—Ç—É—Å –ø–∞—Ü–∏–µ–Ω—Ç–∞</h4>
                            <p class="text-muted">
                                <span class="status-badge status-completed">–ê–∫—Ç–∏–≤–Ω—ã–π</span>
                            </p>
                        </div>
                        <div class="info-section">
                            <h4>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</h4>
                            <p class="text-muted">
                                {% if patient.registered_at %}
                                    {{ patient.registered_at.strftime('%d.%m.%Y %H:%M') }}
                                {% else %}
                                    –ù–µ —É–∫–∞–∑–∞–Ω–æ
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –µ—Å–ª–∏ –ø–∞—Ü–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω -->
        <div class="error-state">
            <div class="error-state-icon">‚ùå</div>
            <h3>–ü–∞—Ü–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</h3>
            <p class="text-muted">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞. –í–æ–∑–º–æ–∂–Ω–æ, –ø–∞—Ü–∏–µ–Ω—Ç –±—ã–ª —É–¥–∞–ª–µ–Ω –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.</p>
            <a href="{{ url_for('patient_list') }}" class="btn btn-primary">
                ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
            </a>
        </div>
        {% endif %}
    </main>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/patient-history.js') }}"></script>
    
</body>
</html>